# Copyright 2018 ETH Zurich and University of Bologna.
# Copyright and related rights are licensed under the Solderpad Hardware
# License, Version 0.51 (the "License"); you may not use this file except in
# compliance with the License.  You may obtain a copy of the License at
# http://solderpad.org/licenses/SHL-0.51. Unless required by applicable law
# or agreed to in writing, software, hardware and materials distributed under
# this License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
# CONDITIONS OF ANY KIND, either express or implied. See the License for the
# specific language governing permissions and limitations under the License.
#
# Author: Michael Schaffner <schaffner@iis.ee.ethz.ch>, ETH Zurich
# Date: 26.11.2018
# Description: GitLab CI configuration script.

before_script:
  - . /eda/mentor/2020-21/scripts/QUESTA-CORE-PRIME_2020.4_RHELx86.sh
  - export QUESTA_HOME=/eda/mentor/2020-21/RHELx86/QUESTA-CORE-PRIME_2020.4
  # eda env mentor licence 
  - export MGLS_LICENSE_FILE=1717@epi03.bsc.es
  - export MGLS1_LICENSE_FILE=1717@epi01.bsc.es
  - export LM_LICENSE_FILE=$LM_LICENSE_FILE:$MGLS_LICENSE_FILE:$MGLS1_LICENSE_FILE
  #- export CI_NUM_JOBS=8
  #- . ./piton/lagarto_setup.sh
  #- . ./piton/lagarto_build_tools.sh 

#variables:
  #GIT_SUBMODULE_STRATEGY: recursive

stages:
  - regression
  - torture

###################################
# Build                           #
###################################
# 
#build:
#  stage: build
#  tags: 
#    - test
#  script:
#    - . ./piton/lagarto_setup.sh
#    - . ./piton/lagarto_build_tools.sh 
#    - cd build
#    - sims -sys=manycore -x_tiles=1 -y_tiles=1 -msm_build -lagarto -config_rtl=BSC_RTL_SRAMS
#    - "grep 'Errors: 0' sims.log"
#    - sims -sys=manycore -x_tiles=1 -y_tiles=1 -msm_build -lagarto -config_rtl=BSC_RTL_SRAMS -config_rtl=OPENPITON_LAGARTO_COMMIT_LOG
#    - "grep 'Errors: 0' sims.log"

##############################################################
## Regression tests                                        ###
##############################################################

regression:
  stage: regression
  tags: 
    - test
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
  script:
    - . ./piton/lagarto_setup.sh
    - . ./piton/lagarto_build_tools.sh 
    - cd build
    - sims -group=lagarto_tile1_rv64ui_tests_p -sim_type=msm
    - "cd 2*"
    - "regreport . -summary | tee -a ../final_report.log"
    - "regreport . -summary | tee regress.log"
    - "grep 'REGRESSION PASSED' regress.log"
    - "cd .."
    - "rm -rf 2*"
    - sims -group=lagarto_tile1_rv64ui_tests_v -sim_type=msm
    - "cd 2*"
    - "regreport . -summary | tee -a ../final_report.log"
    - "regreport . -summary | tee regress.log"
    - "grep 'REGRESSION PASSED' regress.log"
    - "cd .."
    - "rm -rf 2*"
    - sims -group=lagarto_tile1_rv64ua_tests_p -sim_type=msm
    - "cd 2*"
    - "regreport . -summary | tee -a ../final_report.log"
    - "regreport . -summary | tee regress.log"
    - "grep 'REGRESSION PASSED' regress.log"
    - "cd .."
    - "rm -rf 2*"
    - sims -group=lagarto_tile1_rv64ua_tests_v -sim_type=msm
    - "cd 2*"
    - "regreport . -summary | tee -a ../final_report.log"
    - "regreport . -summary | tee regress.log"
    - "grep 'REGRESSION PASSED' regress.log"
    - "cd .."
    - "rm -rf 2*"
    - sims -group=lagarto_tile1_rv64um_tests_p -sim_type=msm
    - "cd 2*"
    - "regreport . -summary | tee -a ../final_report.log"
    - "regreport . -summary | tee regress.log"
    - "grep 'REGRESSION PASSED' regress.log"
    - "cd .."
    - "rm -rf 2*"
    - sims -group=lagarto_tile1_rv64um_tests_v -sim_type=msm
    - "cd 2*"
    - "regreport . -summary | tee -a ../final_report.log"
    - "regreport . -summary | tee regress.log"
    - "grep 'REGRESSION PASSED' regress.log"
    - "cd .."
    - "rm -rf 2*"
    - sims -group=lagarto_tile1_rv64mi_tests_p -sim_type=msm
    - "cd 2*"
    - "regreport . -summary | tee -a ../final_report.log"
    - "regreport . -summary | tee regress.log"
    - "grep 'REGRESSION PASSED' regress.log"
    - "cd .."
    - "rm -rf 2*"
    - sims -group=lagarto_tile1_rv64si_tests_p -sim_type=msm
    - "cd 2*"
    - "regreport . -summary | tee -a ../final_report.log"
    - "regreport . -summary | tee regress.log"
    - "grep 'REGRESSION PASSED' regress.log"
    - "cd .."
    - "rm -rf 2*"
    - sims -group=lagarto_tile1_rv64uf_tests_p -sim_type=msm
    - "cd 2*"
    - "regreport . -summary | tee -a ../final_report.log"
    - "regreport . -summary | tee regress.log"
    - "grep 'REGRESSION PASSED' regress.log"
    - "cd .."
    - "rm -rf 2*"
    - sims -group=lagarto_tile1_rv64uf_tests_v -sim_type=msm
    - "cd 2*"
    - "regreport . -summary | tee -a ../final_report.log"
    - "regreport . -summary | tee regress.log"
    - "grep 'REGRESSION PASSED' regress.log"
    - "cd .."
    - "rm -rf 2*"
    - sims -group=lagarto_tile1_rv64ud_tests_p -sim_type=msm
    - "cd 2*"
    - "regreport . -summary | tee -a ../final_report.log"
    - "regreport . -summary | tee regress.log"
    - "grep 'REGRESSION PASSED' regress.log"
    - "cd .."
    - "rm -rf 2*"
    - sims -group=lagarto_tile1_rv64ud_tests_v -sim_type=msm
    - "cd 2*"
    - "regreport . -summary | tee -a ../final_report.log"
    - "regreport . -summary | tee regress.log"
    - "grep 'REGRESSION PASSED' regress.log"
    - "cd .."
    - "rm -rf 2*"
    - "cat final_report.log"


##############################################################
## Torture tests                                           ###
##############################################################

torture:
  stage: torture
  tags: 
    - test
  timeout: 12h
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - . ./piton/lagarto_setup.sh
    - . ./piton/lagarto_build_tools.sh 
    - cd build
    - . ./ci/lagarto_build_torture.sh large_fp 500
    - . ./ci/lagarto_run_torture.sh large_fp 500
    - "grep 'TEST PASSED' large_fp.report"
  artifacts:
    expire_in: 1 week
    when: on_failure
    paths:
      - piton/design/chip/tile/vas_tile_core/tmp/riscv-torture/artifacts/torture
      - piton/build
